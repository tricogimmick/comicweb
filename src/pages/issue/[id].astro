---
import Layout from '../../layouts/Layout.astro';
import sqlite3 from 'sqlite3';
import type { MagazineType, IssueType } from '../../types/model';
import { getAuthors, getContentType } from '../../lib/functions'

type ParamType = {
    params: {
        id: string
    },
    props: {
        issue: IssueType
    }
};

export type QueryResultype = {
    issue_id: string,
    order_no: number,
    title_id: number,
    title: string,
    page_no: number,
    content_type: number,
    color: number | null,
    serialization_status: number | null,
    description: string | null,
    aurthors: string | null,
    scripters: string | null
}

export function getStaticPaths() {
    const dbPath = import.meta.env.COMICDB_PATH;
	return new Promise<ParamType[]>((ok, ng) => {
        const db = new sqlite3.Database(dbPath);
		db.all<IssueType>("SELECT * FROM issues ORDER BY id", [] , (err, rows) => {
			if (err || rows == null) {
				ng(err || "Data not found");
			} else {
				ok(rows.map(x => ({ params: { id: x.id }, props: { issue: x }})));
			}
		});
        db.close();
	})
}

function getMagazine(db: sqlite3.Database, id: string) {
	return new Promise<MagazineType>((ok, ng) => {
		db.get<MagazineType>("SELECT * FROM magazines WHERE id = ?", [id], (err, row) => {
			if (err || row == null) {
				ng(err || "Data not found");
			} else {
				ok(row);
			}
		});
	})
}

function getContents(db: sqlite3.Database, id: string) {
    return new Promise<QueryResultype[]>((ok, ng) => {
        db.all<QueryResultype>(
            "SELECT c.*, t.title FROM contents as C JOIN titles as t ON t.id = c.title_id WHERE c.issue_id = ? ORDER BY order_no",
            [id], 
            (err, rows) => {
                if (err || rows == null) {
                    ng(err || "Data not found");
                } else {
                    ok(rows);
                }
            });
    });
}

const { issue } = Astro.props;

const dbPath = import.meta.env.COMICDB_PATH;
const db = new sqlite3.Database(dbPath);

const magazine = await getMagazine(db, issue.magazine_id);
const contents = await getContents(db, issue.id);

for (let content of contents) {
    const authors = await getAuthors(db, content.title_id, "AUTHOR");
    const scripters = await getAuthors(db, content.title_id, "SCRIPT");
    content.aurthors = authors.map(a => a.name).join(" & ");
    content.scripters = scripters.map(a => a.name).join(" & ");
}

db.close();


---

<Layout title="Welcome to Astro.">
	<main>
        <h1>{magazine?.title} {issue.title}</h1>
        <p>{issue.description}</p>
        <div>
            <table>
                <thead>
                    <tr>
                        <td>No</td>
                        <td>作品名</td>
                        <td>漫画</td>
                        <td>原作</td>
                        <td>頁</td>
                        <td>種別</td>
                        <td>カラー有無</td>
                        <td>備考</td>
                    </tr>
                </thead>
                <tbody>
                    {contents.map(c => (
                        <tr>
                            <td>{c.order_no}</td>
                            <td><a href={`/title/${c.title_id}`}>{c.title}</a></td>
                            <td>{c.aurthors}</td>
                            <td>{c.scripters}</td>
                            <td>{c.page_no}</td>
                            <td>{getContentType(c.content_type)}</td>
                            <td>{c.color == 1 ? "有" : ""}</td>
                            <td>{c.description}</td>
                        </tr>
                    ))}        
                </tbody>
            </table>
        </div>
        <div>
            <a href="/">戻る</a>
        </div>
    </main>
</Layout>

<style>
	main {
		margin: auto;
		padding: 1.5rem;
		max-width: 1000px;
	}
	h1 {
		font-size: 3rem;
		font-weight: 800;
		margin: 0;
	}
</style>
